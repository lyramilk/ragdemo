# 前端
这里使用了llama.cpp项目的examples/server/public/index.html文件作为前端。在aiohttp中把它映射到了web服务的根目录``http://127.0.0.1:8888/``

# 后端及大模型
用aiohttp代理了llama.cpp的问答请求，在llama.cpp中运行的是Qwen2.5-3B-Instruct模型。
通过aiohttp把部署在``http://127.0.0.1:8080/v1/chat/completions``的llama.cpp映射到aiohttp服务的``http://127.0.0.1:8888/v1/chat/completions``为实现打字效果，使用了aiohttp的``aiohttp.web.StreamResponse``响应类

# 引用了jieba分词
```
pip3 install jieba
```

# 思路

使用llamaindex或langchain无法直观体验rag的全过程，所以本demo并没有使用这些组件，而是用基本的异步代理来实现。 使用简单的字符串搜索替代了复杂的多维向量搜索。具体实现方法是：

- 把民法典按行分割，每行作为一个分片。
- 用户输入案情描述后，对该案情描述进行分词，用每个词去查阅民法典，并对相应条款计算引用次数，然后按引用次数从高到低排序，取引用最多的前20条。
- 替换掉前端页面给llama.cpp传递的系统提示词。并将llama.cpp返回的内容直接转发给前端页面。

下面这个是llama.cpp自带的那个index.html打包的请求格式，替换的就是role为system的这个对象中的ontent。
```
{
    "messages": [
        {
            "role": "system",
            "content": "You are a helpful assistant."
        },
        {
            "id": 1734860742156,
            "role": "user",
            "content": "\u6253\u4eba"
        }
    ],
    "stream": true,
    "cache_prompt": true,
    "samplers": "dkypmxt",
    "temperature": 0.8,
    "dynatemp_range": 0,
    "dynatemp_exponent": 1,
    "top_k": 40,
    "top_p": 0.95,
    "min_p": 0.05,
    "typical_p": 1,
    "xtc_probability": 0,
    "xtc_threshold": 0.1,
    "repeat_last_n": 64,
    "repeat_penalty": 1,
    "presence_penalty": 0,
    "frequency_penalty": 0,
    "dry_multiplier": 0,
    "dry_base": 1.75,
    "dry_allowed_length": 2,
    "dry_penalty_last_n": -1,
    "max_tokens": -1,
    "timings_per_token": false
}

```
替换了系统提示此后的请求是这样
```
{
	"messages": [{
		"role": "system",
		"content": "你是一个法官，已知民法条款:\n\t第一千一百七十九条　侵害他人造成人身损害的，应当赔偿医疗费、护理费、交通费、营养费、住院伙食补助费等为治疗和康复支出的合理费用，以及因误工减少的收入。造成残疾的，还应当赔偿辅助器具费和残疾赔偿金；造成死亡的，还应当赔偿丧葬费和死亡赔偿金。\n\t第一千二百五十六条　在公共道路上堆放、倾倒、遗撒妨碍通行的物品造成他人损害的，由行为人承担侵权责任。公共道路管理人不能证明已经尽到清理、防护、警示等义务的，应当承担相应的责任。\n\t第一千二百五十三条　建筑物、构筑物或者其他设施及其搁置物、悬挂物发生脱落、坠落造成他人损害，所有人、管理人或者使用人不能证明自己没有过错的，应当承担侵权责任。所有人、管理人或者使用人赔偿后，有其他责任人的，有权向其他责任人追偿。\n\t第一千二百一十六条　机动车驾驶人发生交通事故后逃逸，该机动车参加强制保险的，由保险人在机动车强制保险责任限额范围内予以赔偿；机动车不明、该机动车未参加强制保险或者抢救费用超过机动车强制保险责任限额，需要支付被侵权人人身伤亡的抢救、丧葬等费用的，由道路交通事故社会救助基金垫付。道路交通事故社会救助基金垫付后，其管理机构有权向交通事故责任人追偿。\n\t第一百五十七条　民事法律行为无效、被撤销或者确定不发生效力后，行为人因该行为取得的财产，应当予以返还；不能返还或者没有必要返还的，应当折价补偿。有过错的一方应当赔偿对方由此所受到的损失；各方都有过错的，应当各自承担相应的责任。法律另有规定的，依照其规定。\n\t第一千二百三十九条　占有或者使用易燃、易爆、剧毒、高放射性、强腐蚀性、高致病性等高度危险物造成他人损害的，占有人或者使用人应当承担侵权责任；但是，能够证明损害是因受害人故意或者不可抗力造成的，不承担责任。被侵权人对损害的发生有重大过失的，可以减轻占有人或者使用人的责任。\n\t第八百二十条　承运人应当按照有效客票记载的时间、班次和座位号运输旅客。承运人迟延运输或者有其他不能正常运输情形的，应当及时告知和提醒旅客，采取必要的安置措施，并根据旅客的要求安排改乘其他班次或者退票；由此造成旅客损失的，承运人应当承担赔偿责任，但是不可归责于承运人的除外。\n\t第一千一百七十条　二人以上实施危及他人人身、财产安全的行为，其中一人或者数人的行为造成他人损害，能够确定具体侵权人的，由侵权人承担责任；不能确定具体侵权人的，行为人承担连带责任。\n\t第一千二百零九条　因租赁、借用等情形机动车所有人、管理人与使用人不是同一人时，发生交通事故造成损害，属于该机动车一方责任的，由机动车使用人承担赔偿责任；机动车所有人、管理人对损害的发生有过错的，承担相应的赔偿责任。\n\t第一千二百三十条　因污染环境、破坏生态发生纠纷，行为人应当就法律规定的不承担责任或者减轻责任的情形及其行为与损害之间不存在因果关系承担举证责任。\n\t第五百零一条　当事人在订立合同过程中知悉的商业秘密或者其他应当保密的信息，无论合同是否成立，不得泄露或者不正当地使用；泄露、不正当地使用该商业秘密或者信息，造成对方损失的，应当承担赔偿责任。\n\t第一千二百五十八条　在公共场所或者道路上挖掘、修缮安装地下设施等造成他人损害，施工人不能证明已经设置明显标志和采取安全措施的，应当承担侵权责任。\n\t第一千一百五十条　继承开始后，知道被继承人死亡的继承人应当及时通知其他继承人和遗嘱执行人。继承人中无人知道被继承人死亡或者知道被继承人死亡而不能通知的，由被继承人生前所在单位或者住所地的居民委员会、村民委员会负责通知。\n\t第一千二百四十条　从事高空、高压、地下挖掘活动或者使用高速轨道运输工具造成他人损害的，经营者应当承担侵权责任；但是，能够证明损害是因受害人故意或者不可抗力造成的，不承担责任。被侵权人对损害的发生有重大过失的，可以减轻经营者的责任。\n\t第九百九十四条　死者的姓名、肖像、名誉、荣誉、隐私、遗体等受到侵害的，其配偶、子女、父母有权依法请求行为人承担民事责任；死者没有配偶、子女且父母已经死亡的，其他近亲属有权依法请求行为人承担民事责任。\n\t第八十四条　营利法人的控股出资人、实际控制人、董事、监事、高级管理人员不得利用其关联关系损害法人的利益；利用关联关系造成法人损失的，应当承担赔偿责任。\n\t第一千二百一十二条　未经允许驾驶他人机动车，发生交通事故造成损害，属于该机动车一方责任的，由机动车使用人承担赔偿责任；机动车所有人、管理人对损害的发生有过错的，承担相应的赔偿责任，但是本章另有规定的除外。\n\t第一千二百三十七条　民用核设施或者运入运出核设施的核材料发生核事故造成他人损害的，民用核设施的营运单位应当承担侵权责任；但是，能够证明损害是因战争、武装冲突、暴乱等情形或者受害人故意造成的，不承担责任。\n\t第一千二百五十七条　因林木折断、倾倒或者果实坠落等造成他人损害，林木的所有人或者管理人不能证明自己没有过错的，应当承担侵权责任。\n\t第一千一百九十九条　无民事行为能力人在幼儿园、学校或者其他教育机构学习、生活期间受到人身损害的，幼儿园、学校或者其他教育机构应当承担侵权责任；但是，能够证明尽到教育、管理职责的，不承担侵权责任。\n请根据以上法律条文给出审判结果，不要引用其它法律条文:"
	}, {
		"id": 1734862749549,
		"role": "user",
		"content": "2023年7月13日上午8:40左右，廖某到宝兴县灵关镇参加亲戚的葬礼。在送葬过程中，因受暴风雨恶劣天气的影响，山坡上的一颗大树突然被连根拔起，随即倾倒压断一旁的电线杆，断裂的电线杆和倾倒的大树击中廖某等5人。根据现场勘察，大树的树根在倾倒前已经裸露非常多。\n5人于当日被送往医院救治，最终1人死亡、4人不同程度受伤。其中，廖某被诊断为开放性颅脑损伤；右侧额骨凹陷性粉碎性骨折等多处受伤，共花去医疗费63942.61元。后经鉴定：廖某为十级伤残；误工期为180天、护理期为90日、营养期为90日。\n事发后，廖某认为引发事故的电线杆所有人和管理人某县供电分公司应承担赔偿责任，起诉某县供电分公司及其所属的上级某市电力公司，要求赔偿其医疗费、护理费、误工费、生活费、交通费、残疾赔偿金、精神抚慰金、被抚养人生活费等291701.41元。\n某县供电分公司和某市电力公司均认为，发生此次事故系不能预见、不能避免且不能克服的自然灾害造成，不应承担责任。"
	}],
	"stream": true,
	"cache_prompt": true,
	"samplers": "dkypmxt",
	"temperature": 0.8,
	"dynatemp_range": 0,
	"dynatemp_exponent": 1,
	"top_k": 40,
	"top_p": 0.95,
	"min_p": 0.05,
	"typical_p": 1,
	"xtc_probability": 0,
	"xtc_threshold": 0.1,
	"repeat_last_n": 64,
	"repeat_penalty": 1,
	"presence_penalty": 0,
	"frequency_penalty": 0,
	"dry_multiplier": 0,
	"dry_base": 1.75,
	"dry_allowed_length": 2,
	"dry_penalty_last_n": -1,
	"max_tokens": -1,
	"timings_per_token": false
}
```